# 使用说明

本文档介绍简易防火墙软件的运行方式、界面组成以及规则配置说明。

## 1. 系统简介

程序采用 **代理转发** 思路：防火墙监听本地端口，按照配置将数据转发到后端真实服务，同时在转发过程中依据规则进行过滤。所有判决均由统一的规则引擎完成，支持协议类型、IP、端口、内容特征、白名单与黑名单等条件。

## 2. 快速体验

1. 启动目标服务，例如在本机运行一个 HTTP/echo 服务；
2. 在防火墙界面中设置监听端口与后端端口（两者可不同）；
3. 勾选需要启用的协议（TCP/UDP），添加规则；
4. 点击“启动防火墙”，将外部客户端连接指向防火墙监听的端口，即可通过图形界面实时查看日志。

> 示例：监听 `0.0.0.0:9000`，后端为 `127.0.0.1:8000` 的 echo 服务。外部客户端连接到防火墙 `9000` 端口，防火墙判决后再转发给后端。

## 3. 界面说明

界面包含三个主要区域：

1. **代理配置**：设置监听地址/端口、后端地址/端口，并选择默认策略（允许或拒绝）。提供按钮快速启动或停止防火墙；
2. **规则管理**：以表格形式列出当前生效的规则，可增删规则、添加白/黑名单；
3. **实时日志**：每秒刷新，展示最近 200 条判决结果，包括时间、动作、数据包源/目的地址与命中规则。

## 4. 规则配置

- **动作**：`ALLOW` 表示放行，`DENY` 表示拒绝；
- **协议**：支持 `ANY`、`TCP`、`UDP`；
- **IP**：可以填写具体 IP，也可填写 `*` 或 CIDR（如 `192.168.1.0/24`）；
- **端口**：支持单个端口、端口范围（`8000-8100`）或逗号分隔的多个端口；
- **内容特征**：可填写正则表达式，用于匹配 TCP/UDP 数据负载中的文本内容。

规则列表按照添加顺序匹配，命中后立即返回结果，不再继续匹配后续规则。可通过白名单或黑名单快速设置“总是允许/总是拒绝”的 IP 与端口组合。

## 5. 日志与持久化

- 日志面板显示内存中最近的若干条记录；
- 点击关闭窗口时会自动停止后台事件循环；
- 若需导出日志，可调用 `FirewallEngine.export_logs()` 接口保存为文本文件。

## 6. 常见问题

1. **界面无响应？** 请确认 Python 环境已安装 Tkinter 并支持 GUI；
2. **如何在无界面环境运行？** 可参考 `firewall.main` 中的示例，直接实例化引擎与服务，编写 CLI；
3. **UDP 转发是否支持多客户端？** 该实现为教学示例，针对 UDP 采用简单映射策略，适合演示和小规模测试场景，生产环境可扩展为更复杂的 NAT/会话管理。

## 7. 进一步扩展

- 对接第三方规则库，实现自动加载；
- 将日志输出到数据库或远程监控系统；
- 集成入侵检测算法，实现更复杂的内容分析。

如需二次开发，可直接使用 `FirewallEngine`、`FirewallRule` 等模块，也可以替换 `proxy` 模块，实现基于原始套接字的包过滤。
